@model WebApp.Models.Admin.Translations.AdminTranslationsIndexVm
@using App.Domain.Enum

@{
    ViewData["Title"] = "Live translations";
}

<div class="page-head mb-3">
    <div>
        <h2 class="page-title mb-1">@ViewData["Title"]</h2>
        <div class="page-subtitle text-muted">
            Review current live content and filter by language, version, or state.
        </div>
    </div>

    <div class="page-actions d-flex gap-2">
        <a class="btn btn-primary"
           asp-action="Publish"
           asp-route-languageId="@Model.SelectedLanguageId">
            <i class="bi bi-pencil-square me-2"></i>
            Change translation
        </a>
    </div>
</div>

<div class="card app-card">
    <div class="card-body p-3 p-lg-4">
        <!-- Filters -->
        <form method="get" class="row g-2 align-items-end mb-3">
            <div class="col-12 col-md-5 col-lg-4">
                <label class="form-label mb-1">Language</label>
                <select name="languageId" class="form-select">
                    @foreach (var lang in Model.LanguageOptions)
                    {
                        <option value="@lang.Id"
                                selected="@(Model.SelectedLanguageId.HasValue && Model.SelectedLanguageId.Value == lang.Id ? "selected" : null)">
                            @lang.Display
                        </option>
                    }
                </select>
            </div>

            <div class="col-12 col-md-3 col-lg-2">
                <label class="form-label mb-1">Version</label>
                <input type="number"
                       class="form-control"
                       name="version"
                       min="1"
                       value="@(Model.SelectedVersion?.ToString() ?? "")"
                       placeholder="Any" />
            </div>

            <div class="col-12 col-md-4 col-lg-3">
                <label class="form-label mb-1">State</label>
                <select name="state" class="form-select">
                    <option value="">All states</option>
                    @foreach (TranslationState st in Enum.GetValues(typeof(TranslationState)))
                    {
                        <option value="@st"
                                selected="@(Model.SelectedState.HasValue && Model.SelectedState.Value == st ? "selected" : null)">
                            @st
                        </option>
                    }
                </select>
            </div>

            <div class="col-12 col-lg-3 d-grid d-sm-flex gap-2 justify-content-lg-end">
                <button type="submit" class="btn btn-outline-secondary">
                    <i class="bi bi-funnel me-2"></i>Filter
                </button>

                <a class="btn btn-outline-secondary"
                   asp-action="Index"
                   asp-route-languageId="@Model.SelectedLanguageId">
                    <i class="bi bi-x-circle me-2"></i>Reset
                </a>
            </div>
        </form>

        <!-- Table -->
        <div class="table-responsive app-table-wrap">
            <table class="table app-table align-middle mb-0">
                <thead>
                <tr>
                    <th style="width: 110px;">Lang</th>
                    <th style="width: 340px;">Resource key</th>
                    <th>Content</th>
                    <th class="text-end" style="width: 90px;">Ver</th>
                    <th style="width: 160px;">State</th>
                </tr>
                </thead>

                <tbody>
                @if (Model.Rows.Count == 0)
                {
                    <tr>
                        <td colspan="5">
                            <div class="empty-state py-4">
                                <div class="empty-icon" aria-hidden="true">
                                    <i class="bi bi-inboxes"></i>
                                </div>
                                <div>
                                    <div class="fw-semibold">No live translations</div>
                                    <div class="text-muted small">Try changing filters or pick a different language.</div>
                                </div>
                            </div>
                        </td>
                    </tr>
                }
                else
                {
                    foreach (var r in Model.Rows)
                    {
                        <tr>
                            <td>
                                <span class="badge text-bg-light border font-monospace">@r.LanguageTag</span>
                            </td>

                            <td>
                                <div class="fw-semibold text-truncate" title="@r.FriendlyKey">@r.FriendlyKey</div>
                                <div class="text-muted small text-truncate" title="@r.ResourceKey">@r.ResourceKey</div>
                            </td>

                            <td class="content-cell">
                                @if (string.IsNullOrWhiteSpace(r.Content))
                                {
                                    <span class="text-muted">—</span>
                                }
                                else
                                {
                                    <div class="content-preview" title="@r.Content">@r.Content</div>
                                }
                            </td>

                            <td class="text-end">
                                <span class="badge text-bg-light border font-monospace">@r.VersionNumber</span>
                            </td>

                            <td>
                                @Html.Raw(StateBadge(r.TranslationState))
                            </td>
                        </tr>
                    }
                }
                </tbody>
            </table>
        </div>

    </div>
</div>

@functions{
    private static string StateBadge(TranslationState state)
    {
        // Use consistent “soft” badge styles (still Bootstrap-native)
        var (cls, txt, icon) = state switch
        {
            TranslationState.Published => ("text-bg-success", "Published", "check-circle"),
            TranslationState.WaitingReview => ("text-bg-warning", "Waiting review", "hourglass-split"),
            TranslationState.Approved => ("text-bg-success", "Approved", "check2"),
            TranslationState.Rejected => ("text-bg-danger", "Rejected", "x-circle"),
            TranslationState.Depricated => ("text-bg-secondary", "Archived", "archive"),
            _ => ("text-bg-light", state.ToString(), "info-circle")
        };

        // Add icon + ensure contrast on warning
        var extra = state == TranslationState.WaitingReview ? " text-dark" : "";
        return $"<span class=\"badge {cls}{extra}\"><i class=\"bi bi-{icon} me-1\"></i>{txt}</span>";
    }
}